{% extends 'base.html' %}

{% block title %}Request Borrow - Smart Supply{% endblock %}

{% block content %}
<div x-data="borrowSingle()" class="max-w-7xl mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-10 flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
            <nav class="flex mb-4" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2 text-sm text-gray-700 font-black">
                    <li><a href="{% url 'dashboard' %}" class="hover:text-red-600 transition-colors">Dashboard</a></li>
                    <li class="flex items-center whitespace-nowrap"><i class="fas fa-chevron-right text-xs mx-2 text-gray-400"></i> Borrow</li>
                    <li class="flex items-center whitespace-nowrap"><i class="fas fa-chevron-right text-xs mx-2 text-gray-400"></i> <span class="text-gray-900 underline decoration-red-500 decoration-2">Single Request</span></li>
                </ol>
            </nav>
            <h1 class="text-4xl font-black tracking-tight text-gray-900 sm:text-5xl">
                Request <span class="text-red-600">Borrow</span>
            </h1>
            <p class="mt-2 text-lg text-gray-800 font-medium">Select an item and submit a request for GSO approval.</p>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'request_borrow_batch' %}" class="btn bg-white border border-gray-300 text-gray-900 hover:bg-gray-50 px-6 py-3 rounded-xl transition-all shadow-md flex items-center font-black">
                <i class="fas fa-layer-group mr-2 text-orange-600"></i> Batch Request
            </a>
            <a href="{% url 'request_list' %}" class="btn bg-white border border-gray-300 text-gray-900 hover:bg-gray-50 px-6 py-3 rounded-xl transition-all shadow-md flex items-center font-black">
                <i class="fas fa-history mr-2 text-red-600"></i> My Requests
            </a>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
        
        <!-- Left Column: Form (5 cols) -->
        <div class="lg:col-span-12 xl:col-span-5 space-y-6">
            <div class="glass-panel rounded-3xl overflow-hidden border border-gray-100 shadow-xl bg-white">
                <div class="bg-red-700 px-6 py-4 flex items-center justify-between text-white border-b border-red-800 shadow-inner">
                    <h2 class="text-xl font-black flex items-center tracking-tight">
                        <i class="fas fa-file-signature mr-3 text-red-100"></i> Request Form
                    </h2>
                </div>
                
                <form method="post" class="p-6 space-y-5">
                    {% csrf_token %}
                    
                    {% if not can_borrow %}
                    <div class="mb-6 bg-red-50 border border-red-200 p-4 rounded-2xl flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-600 mt-1 mr-3"></i>
                        <div>
                            <p class="text-red-900 text-sm font-black italic">Borrowing Restricted</p>
                            <p class="text-red-700 text-xs mt-1 font-bold">
                                You have {{ overdue_items.count }} overdue item(s).
                                <a href="{% url 'borrowed_items_list' %}" class="underline hover:text-red-900 ml-1">Return them first</a>
                            </p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Searchable Selection -->
                    <div>
                        <label class="block text-sm font-black text-gray-900 mb-2">Item to Borrow *</label>
                        <div class="relative group" @click.away="open = false">
                            <i class="fas fa-box absolute left-4 top-3.5" :class="selectedItem ? 'text-red-600' : 'text-gray-400'"></i>
                            <input type="text" x-model="searchQuery" @focus="open = true" 
                                placeholder="Search inventory..."
                                class="w-full pl-11 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-red-600 focus:bg-white transition-all font-black text-gray-900 outline-none">
                            
                            <!-- Search Results Dropdown -->
                            <div x-show="open && filteredItems.length > 0" x-transition
                                class="absolute z-10 w-full mt-2 bg-white border border-gray-200 rounded-2xl shadow-2xl max-h-60 overflow-y-auto custom-scrollbar">
                                <template x-for="item in filteredItems" :key="item.id">
                                    <div @click="selectItem(item)" 
                                        class="p-4 hover:bg-gray-50 border-b border-gray-100 cursor-pointer flex justify-between items-center group">
                                        <div>
                                            <p class="font-black text-gray-900 group-hover:text-red-600 transition-colors" x-text="item.name"></p>
                                            <p class="text-[10px] text-gray-500 font-bold uppercase" x-text="item.category"></p>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-sm font-black text-red-600" x-text="item.stock"></span>
                                            <span class="text-[9px] text-gray-500 font-black uppercase" x-text="item.unit"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <select name="supply" x-model="selectedId" class="hidden" required>
                                <option value=""></option>
                                <template x-for="item in items" :key="item.id">
                                    <option :value="item.id" x-text="item.name"></option>
                                </template>
                            </select>
                        </div>
                    </div>

                    <!-- Selected Item Info Card -->
                    <template x-if="selectedItem">
                        <div class="space-y-4">
                            <div class="bg-indigo-50/50 border border-indigo-100 p-4 rounded-2xl flex justify-between items-center transition-all animate-pulse-subtle">
                                <div>
                                    <p class="text-[10px] font-black text-indigo-700 uppercase tracking-widest">Selected Item</p>
                                    <p class="text-lg font-black text-indigo-900" x-text="selectedItem.name"></p>
                                    <p class="text-xs text-indigo-600 font-bold" x-text="selectedItem.location"></p>
                                </div>
                                <div class="text-right bg-white p-3 rounded-xl shadow-sm border border-indigo-100">
                                    <p class="text-[9px] font-black text-indigo-800 uppercase leading-none mb-1">Stock</p>
                                    <p class="text-2xl font-black text-red-600 leading-none" x-text="selectedItem.stock"></p>
                                    <p class="text-[9px] font-black text-gray-500 uppercase mt-1" x-text="selectedItem.unit"></p>
                                </div>
                            </div>

                            <!-- Instance Selection for Single Item -->
                            <template x-if="selectedItem.instances && selectedItem.instances.length > 0">
                                <div class="p-4 bg-white border border-gray-100 rounded-2xl shadow-sm">
                                    <label class="text-[10px] font-black text-gray-500 uppercase mb-3 block tracking-widest">Select Specific Units</label>
                                    <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1">
                                        <template x-for="inst in selectedItem.instances" :key="inst.id">
                                            <div @click="toggleInstance(inst)" 
                                                :class="isInstanceSelected(inst.id) ? 'bg-red-700 text-white border-red-800 shadow-md ring-2 ring-red-100' : 'bg-gray-50 text-gray-900 border-gray-200 hover:bg-gray-100'"
                                                class="px-3 py-2 rounded-xl text-xs font-black border cursor-pointer transition-all">
                                                <span x-text="inst.code"></span>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="mt-3 pt-3 border-t border-gray-50 flex justify-between items-center">
                                        <span class="text-[9px] font-black text-indigo-700 uppercase">Selected:</span>
                                        <span class="text-sm font-black text-indigo-900" x-text="`${selectedInstances.length} Units`"></span>
                                    </div>

                                    <!-- Hidden Inputs for Submission -->
                                    <template x-for="inst in selectedInstances" :key="'submit-'+inst.id">
                                        <input type="hidden" :name="`instances_${selectedItem.id}`" :value="inst.id">
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-black text-gray-900 mb-2">Quantity *</label>
                            <input type="number" name="quantity_requested" x-model="quantity" min="1" :max="selectedItem ? selectedItem.stock : 1" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-red-600 focus:bg-white transition-all font-black outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-gray-900 mb-2">Duration (Days)</label>
                            <input type="number" name="borrow_duration_days" x-model="duration" min="1" max="365" required
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-red-600 focus:bg-white transition-all font-black outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-black text-gray-900 mb-2">Usage Location (Optional)</label>
                        <input type="text" name="requested_location" x-model="location"
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-red-600 focus:bg-white transition-all font-black outline-none"
                            placeholder="Deployment area">
                    </div>

                    <div>
                        <label class="block text-sm font-black text-gray-900 mb-2">Purpose *</label>
                        <textarea name="purpose" x-model="purpose" rows="3" required
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-2xl focus:ring-2 focus:ring-red-600 focus:bg-white transition-all font-black outline-none resize-none"
                            placeholder="What will you use this for?"></textarea>
                    </div>

                    <div class="pt-4">
                        <button type="submit" :disabled="!canSubmit || !{{ can_borrow|lower }}"
                            class="w-full py-4 bg-red-600 hover:bg-red-700 text-white font-black rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all disabled:bg-gray-200 disabled:text-gray-500 disabled:shadow-none disabled:cursor-not-allowed">
                            <i class="fas fa-paper-plane mr-2"></i> Submit Request
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Column: Guidelines (7 cols) -->
        <div class="xl:col-span-7 space-y-6">
            <div class="bg-gray-900 rounded-3xl p-8 text-white shadow-2xl relative overflow-hidden">
                <i class="fas fa-info-circle absolute -right-8 -bottom-8 text-[12rem] opacity-5"></i>
                <h3 class="text-sm font-black uppercase tracking-[0.2em] text-orange-500 mb-6 flex items-center">
                    <span class="w-8 h-[2px] bg-orange-500 mr-3"></span> Next Steps
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="bg-red-600/20 text-red-500 w-8 h-8 rounded-lg flex items-center justify-center font-black mr-4 flex-shrink-0">1</div>
                            <div>
                                <h4 class="font-black text-white">Submit Request</h4>
                                <p class="text-xs text-gray-400 mt-1">Submit your details for verification.</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-red-600/20 text-red-500 w-8 h-8 rounded-lg flex items-center justify-center font-black mr-4 flex-shrink-0">2</div>
                            <div>
                                <h4 class="font-black text-white">GSO Review</h4>
                                <p class="text-xs text-gray-400 mt-1">Staff will check item availability.</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="bg-red-600/20 text-red-500 w-8 h-8 rounded-lg flex items-center justify-center font-black mr-4 flex-shrink-0">3</div>
                            <div>
                                <h4 class="font-black text-white">Date Setting</h4>
                                <p class="text-xs text-gray-400 mt-1">staff sets exact return deadlines.</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-red-600/20 text-red-500 w-8 h-8 rounded-lg flex items-center justify-center font-black mr-4 flex-shrink-0">4</div>
                            <div>
                                <h4 class="font-black text-white">Track Progress</h4>
                                <p class="text-xs text-gray-400 mt-1">Follow updates in your request list.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Info 1 -->
                <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-xl flex items-start gap-4">
                    <div class="bg-orange-100 p-4 rounded-2xl text-orange-600">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                    <div>
                        <h4 class="font-black text-gray-900">Overdue Policy</h4>
                        <p class="text-xs text-gray-600 mt-1 font-medium italic">Borrowing is blocked if you have any unreturned items past their deadline.</p>
                    </div>
                </div>
                <!-- Info 2 -->
                <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-xl flex items-start gap-4">
                    <div class="bg-blue-100 p-4 rounded-2xl text-blue-600">
                        <i class="fas fa-calendar-check text-2xl"></i>
                    </div>
                    <div>
                        <h4 class="font-black text-gray-900">Return Terms</h4>
                        <p class="text-xs text-gray-600 mt-1 font-medium italic">Items must be returned in good condition by the specified date.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function borrowSingle() {
    return {
        items: JSON.parse('{{ non_consumable_supplies|escapejs }}'),
        searchQuery: '',
        selectedId: '',
        selectedItem: null,
        selectedInstances: [],
        open: false,
        duration: 3,
        quantity: 1,
        location: '',
        purpose: '',

        get filteredItems() {
            if (!this.searchQuery) return this.items.slice(0, 10);
            const q = this.searchQuery.toLowerCase();
            return this.items.filter(i => 
                i.name.toLowerCase().includes(q) || 
                i.category.toLowerCase().includes(q)
            ).slice(0, 10);
        },

        selectItem(item) {
            this.selectedItem = item;
            this.selectedId = item.id;
            this.searchQuery = item.name;
            this.open = false;
            this.quantity = 1;
            this.selectedInstances = [];
        },

        toggleInstance(inst) {
            const current = [...this.selectedInstances];
            const index = current.findIndex(i => i.id === inst.id);
            if (index > -1) {
                current.splice(index, 1);
            } else {
                current.push(inst);
            }
            this.selectedInstances = current;
            this.quantity = this.selectedInstances.length || 1;
        },

        isInstanceSelected(id) {
            return this.selectedInstances.some(i => i.id === id);
        },

        get canSubmit() {
            const basic = this.selectedId && this.duration > 0 && this.quantity > 0 && this.purpose.trim().length > 0;
            if (this.selectedItem && this.selectedItem.instances && this.selectedItem.instances.length > 0) {
                return basic && this.selectedInstances.length > 0;
            }
            return basic;
        }
    }
}
</script>

<style>
@keyframes pulse-subtle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}
.animate-pulse-subtle {
    animation: pulse-subtle 3s ease-in-out infinite;
}
</style>
{% endblock %}
