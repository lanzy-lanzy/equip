{% extends 'base.html' %}
{% load humanize %}

{% block title %}Reports - Smart Supply Management System{% endblock %}

{% block extra_head %}
<style>
    .dataTables_wrapper .dataTables_filter {
        float: right;
        margin-bottom: 10px;
    }
    .dataTables_wrapper .dataTables_length {
        float: left;
        margin-bottom: 10px;
    }
    .dataTables_wrapper .dataTables_paginate {
        float: right;
        margin-top: 10px;
    }
    .dataTables_wrapper .dataTables_info {
        float: left;
        margin-top: 10px;
    }
    .dataTables_wrapper .dataTables_processing {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.9);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table.dataTable thead th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
        padding: 12px 16px;
        text-align: left;
        white-space: nowrap;
    }
    table.dataTable tbody td {
        padding: 10px 16px;
        color: #374151;
    }
    table.dataTable tbody tr:hover {
        background-color: #f9fafb !important;
    }
    table.dataTable tbody tr.odd {
        background-color: #ffffff;
    }
    table.dataTable tbody tr.even {
        background-color: #f9fafb;
    }
    .dataTables_wrapper .dataTables_filter input {
        margin-left: 8px;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        outline: none;
    }
    .dataTables_wrapper .dataTables_filter input:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    .paginate_button {
        padding: 8px 12px !important;
        margin: 0 2px !important;
        border-radius: 6px !important;
        border: 1px solid #e5e7eb !important;
        background: white !important;
        color: #374151 !important;
    }
    .paginate_button:hover {
        background: #f3f4f6 !important;
        border-color: #d1d5db !important;
    }
    .paginate_button.current {
        background: #4f46e5 !important;
        border-color: #4f46e5 !important;
        color: white !important;
    }
    .paginate_button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    select.dataTables_length {
        padding: 6px 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        outline: none;
        margin-right: 8px;
    }
    .dt-buttons {
        margin-bottom: 10px;
    }
    .dt-button {
        padding: 8px 16px !important;
        margin-right: 4px !important;
        border-radius: 6px !important;
        border: none !important;
        font-weight: 500 !important;
        cursor: pointer !important;
        transition: all 0.2s !important;
    }
    .dt-button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    .buttons-csv {
        background-color: #22c55e !important;
        color: white !important;
    }
    .buttons-pdf {
        background-color: #ef4444 !important;
        color: white !important;
    }
    .buttons-print {
        background-color: #6b7280 !important;
        color: white !important;
    }
    .buttons-copy {
        background-color: #8b5cf6 !important;
        color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Reports & Analytics</h1>
    <p class="text-gray-600">Comprehensive insights into supply management and usage</p>
</div>

<!-- Filters Section -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Filter & Search</h2>
    <form id="reports-filter-form" hx-get="{% url 'reports' %}" hx-target="#report-content" hx-swap="innerHTML">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-4">
            <!-- Search Input -->
            <div>
                <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" id="search" name="search" placeholder="Search..." value="{{ search_query }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <!-- User Filter -->
            <div>
                <label for="user" class="block text-sm font-medium text-gray-700 mb-1">User</label>
                <input type="text" id="user" name="user" placeholder="Filter by user..." value="{{ user_filter }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <!-- Date From -->
            <div>
                <label for="date_from" class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                <input type="date" id="date_from" name="date_from" value="{{ date_from }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <!-- Date To -->
            <div>
                <label for="date_to" class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                <input type="date" id="date_to" name="date_to" value="{{ date_to }}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            </div>

            <!-- Status Filter -->
            <div>
                <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="status" name="status"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="">All Statuses</option>
                    {% for value, label in request_statuses %}
                    <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Report Type -->
            <div>
                <label for="report_type" class="block text-sm font-medium text-gray-700 mb-1">Report Type</label>
                <select id="report_type" name="report_type"
                    onchange="document.getElementById('reports-filter-form').submit()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="overview" {% if report_type == 'overview' %}selected{% endif %}>Overview</option>
                    <option value="requests" {% if report_type == 'requests' %}selected{% endif %}>Requests</option>
                    <option value="transactions" {% if report_type == 'transactions' %}selected{% endif %}>Transactions
                    </option>
                    <option value="supplies" {% if report_type == 'supplies' %}selected{% endif %}>Supplies</option>
                    <option value="users" {% if report_type == 'users' %}selected{% endif %}>Users</option>
                </select>
            </div>
        </div>

        <!-- Filter Actions -->
        <div class="flex gap-2">
            <button type="submit"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
                <i class="fas fa-search"></i>
                Apply Filters
            </button>
            <a href="{% url 'reports' %}"
                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                Clear Filters
            </a>
        </div>
    </form>
</div>

<div id="report-content">
    <!-- Summary Cards -->
    {% if report_type == 'overview' %}
    {% include 'inventory/partials/reports_overview.html' %}
    {% endif %}

    <!-- Requests Report Table -->
    {% if report_type == 'requests' %}
    {% include 'inventory/partials/reports_requests_table.html' %}
    {% endif %}

    <!-- Transactions Report Table -->
    {% if report_type == 'transactions' %}
    {% include 'inventory/partials/reports_transactions_table.html' %}
    {% endif %}

    <!-- Supplies Report Table -->
    {% if report_type == 'supplies' %}
    {% include 'inventory/partials/reports_supplies_table.html' %}
    {% endif %}

    <!-- Users Report Table -->
    {% if report_type == 'users' %}
    {% include 'inventory/partials/reports_users_table.html' %}
    {% endif %}
</div>

<!-- Export Options -->
<div class="mt-8 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Export Reports</h2>
    <p class="text-sm text-gray-600 mb-4">Filters applied above will be included in exports</p>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="font-medium text-gray-800 mb-3">Supplies Report</h3>
            <div class="flex space-x-2">
                <a href="{% url 'export_supplies_csv' %}?search={{ search_query }}&date_from={{ date_from }}&date_to={{ date_to }}"
                    class="flex-1 flex items-center justify-center p-2 bg-blue-50 rounded hover:bg-blue-100 transition-colors">
                    <i class="fas fa-file-csv text-blue-600 mr-1"></i>
                    <span class="text-xs font-medium text-blue-800">CSV</span>
                </a>
                <a href="{% url 'export_supplies_pdf' %}?search={{ search_query }}&date_from={{ date_from }}&date_to={{ date_to }}"
                    class="flex-1 flex items-center justify-center p-2 bg-red-50 rounded hover:bg-red-100 transition-colors">
                    <i class="fas fa-file-pdf text-red-600 mr-1"></i>
                    <span class="text-xs font-medium text-red-800">PDF</span>
                </a>
            </div>
        </div>

        <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="font-medium text-gray-800 mb-3">Requests Report</h3>
            <div class="flex space-x-2">
                <a href="{% url 'export_requests_csv' %}?search={{ search_query }}&date_from={{ date_from }}&date_to={{ date_to }}&status={{ status_filter }}"
                    class="flex-1 flex items-center justify-center p-2 bg-green-50 rounded hover:bg-green-100 transition-colors">
                    <i class="fas fa-file-csv text-green-600 mr-1"></i>
                    <span class="text-xs font-medium text-green-800">CSV</span>
                </a>
                <a href="{% url 'export_requests_pdf' %}?search={{ search_query }}&date_from={{ date_from }}&date_to={{ date_to }}&status={{ status_filter }}"
                    class="flex-1 flex items-center justify-center p-2 bg-red-50 rounded hover:bg-red-100 transition-colors">
                    <i class="fas fa-file-pdf text-red-600 mr-1"></i>
                    <span class="text-xs font-medium text-red-800">PDF</span>
                </a>
            </div>
        </div>

        <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="font-medium text-gray-800 mb-3">Transactions Report</h3>
            <div class="flex space-x-2">
                <a href="{% url 'export_transactions_csv' %}?search={{ search_query }}&date_from={{ date_from }}&date_to={{ date_to }}"
                    class="flex-1 flex items-center justify-center p-2 bg-purple-50 rounded hover:bg-purple-100 transition-colors">
                    <i class="fas fa-file-csv text-purple-600 mr-1"></i>
                    <span class="text-xs font-medium text-purple-800">CSV</span>
                </a>
                <a href="{% url 'export_transactions_pdf' %}?search={{ search_query }}&date_from={{ date_from }}&date_to={{ date_to }}"
                    class="flex-1 flex items-center justify-center p-2 bg-red-50 rounded hover:bg-red-100 transition-colors">
                    <i class="fas fa-file-pdf text-red-600 mr-1"></i>
                    <span class="text-xs font-medium text-red-800">PDF</span>
                </a>
            </div>
        </div>

        <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="font-medium text-gray-800 mb-3">Borrowed Items Report</h3>
            <div class="flex space-x-2">
                <a href="{% url 'export_borrowed_items_csv' %}?search={{ search_query }}&status={{ status_filter }}"
                    class="flex-1 flex items-center justify-center p-2 bg-yellow-50 rounded hover:bg-yellow-100 transition-colors">
                    <i class="fas fa-file-csv text-yellow-600 mr-1"></i>
                    <span class="text-xs font-medium text-yellow-800">CSV</span>
                </a>
                <a href="{% url 'export_borrowed_items_pdf' %}?search={{ search_query }}&status={{ status_filter }}"
                    class="flex-1 flex items-center justify-center p-2 bg-red-50 rounded hover:bg-red-100 transition-colors">
                    <i class="fas fa-file-pdf text-red-600 mr-1"></i>
                    <span class="text-xs font-medium text-red-800">PDF</span>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function initializeDataTable(tableId, reportType) {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        if ($.fn.DataTable.isDataTable('#' + tableId)) {
            $('#' + tableId).DataTable().destroy();
        }
        
        const buttons = [];
        if (reportType !== 'users') {
            buttons.push(
                {
                    extend: 'copy',
                    text: '<i class="fas fa-copy"></i> Copy',
                    className: 'buttons-copy',
                    title: reportType.charAt(0).toUpperCase() + reportType.slice(1) + ' Report'
                },
                {
                    extend: 'csv',
                    text: '<i class="fas fa-file-csv"></i> CSV',
                    className: 'buttons-csv',
                    title: reportType.charAt(0).toUpperCase() + reportType.slice(1) + ' Report',
                    filename: reportType + '_report_' + new Date().toISOString().slice(0,10)
                },
                {
                    extend: 'pdf',
                    text: '<i class="fas fa-file-pdf"></i> PDF',
                    className: 'buttons-pdf',
                    title: reportType.charAt(0).toUpperCase() + reportType.slice(1) + ' Report',
                    filename: reportType + '_report_' + new Date().toISOString().slice(0,10),
                    orientation: 'landscape',
                    pageSize: 'A4'
                },
                {
                    extend: 'print',
                    text: '<i class="fas fa-print"></i> Print',
                    className: 'buttons-print',
                    title: reportType.charAt(0).toUpperCase() + reportType.slice(1) + ' Report'
                }
            );
        }
        
        $('#' + tableId).DataTable({
            paging: true,
            pageLength: 10,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, 'All']],
            searching: true,
            ordering: true,
            info: true,
            responsive: true,
            autoWidth: false,
            language: {
                search: '<i class="fas fa-search"></i> Search:',
                searchPlaceholder: 'Search any column...',
                lengthMenu: 'Show _MENU_ entries',
                info: 'Showing _START_ to _END_ of _TOTAL_ entries',
                infoEmpty: 'Showing 0 to 0 of 0 entries',
                infoFiltered: '(filtered from _MAX_ total entries)',
                paginate: {
                    first: '<i class="fas fa-angle-double-left"></i>',
                    previous: '<i class="fas fa-chevron-left"></i>',
                    next: '<i class="fas fa-chevron-right"></i>',
                    last: '<i class="fas fa-angle-double-right"></i>'
                },
                zeroRecords: 'No matching records found'
            },
            dom: 'lBfrtip',
            buttons: buttons,
            order: [[6, 'desc']],
            columnDefs: [
                { 
                    targets: '_all', 
                    searchable: true,
                    sortable: true
                }
            ],
            initComplete: function() {
                const api = this.api();
                const searchInput = $(this).closest('.dataTables_wrapper').find('.dataTables_filter input');
                searchInput.css({
                    'width': '250px',
                    'border': '1px solid #e5e7eb',
                    'border-radius': '8px',
                    'padding': '10px 14px',
                    'font-size': '14px',
                    'transition': 'all 0.2s'
                });
                searchInput.focus(function() {
                    $(this).css({
                        'border-color': '#6366f1',
                        'box-shadow': '0 0 0 3px rgba(99, 102, 241, 0.1)'
                    });
                }).blur(function() {
                    $(this).css({
                        'border-color': '#e5e7eb',
                        'box-shadow': 'none'
                    });
                });
            }
        });
    }
    
    function initAllTables() {
        initializeDataTable('requests-table', 'requests');
        initializeDataTable('supplies-table', 'supplies');
        initializeDataTable('transactions-table', 'transactions');
        initializeDataTable('users-table', 'users');
    }
    
    initAllTables();
    
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'report-content') {
            setTimeout(initAllTables, 100);
        }
    });
});
</script>

{% endblock %}